<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="layout/default_layout">
<th:block layout:fragment="content">
 <head>
 <title>CodeGym ë¡œê·¸ì¸</title>
 <style>
	
	.login {
		margin: 150px auto 100px auto;
		padding: 50px;
		text-align: center;
		border: 3px solid;
		width: 500px;
		border-radius: 8px 8px 0 0;
	}
	.loginForm{
		border: 0px solid;
	}
	.login_btn {
		position:relative;
		left:40%;
		transform: translateX(-50%);
		margin: 40px 0;
		width:80%;
		height:40px;
		background: linear-gradient(125deg,#2fb380,#238660,#81ecec);
		background-position: left;
		background-size: 200%;
		color:white;
		font-weight: bold;
		border:none;
		cursor:pointer;
		transition: 0.4s;
		display:inline;
	}
	#msg {
		color:red;
		margin-top: 10px;
		
	}
	a {
 		text-decoration-line: none;
 		color : black;
	}
	.authBox {
	    display: flex;
	    align-items: center;
	    justify-content: space-evenly;
	    margin: 10px 0 20px 0;
	}
 </style>
 </head> 
<!-- ê°œë°œ ì˜ì—­ ì‹œì‘ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/aes.js"></script>
<div class="login">
	<h1>ë¡œê·¸ì¸</h1>

	<form name="loginForm" id="loginForm" class="loginForm" method="post"> 

		<input type="text" name="userid" id="userid" class="userid" maxlength="20" placeholder="ì•„ì´ë””">
		<input type="password" id="password" name="password" class="userpasswd" maxlength="20" onkeydown="press(this.form)" placeholder="ë¹„ë°€ë²ˆí˜¸">
		
		<p id="msg"></p> 
		<br>
		<input type="checkbox" id="rememberUserid" onclick="checkRememberUserid()">ì•„ì´ë”” ê¸°ì–µ
		<input type="checkbox" id="rememberPassword" onclick="checkRememberPassword()">íŒ¨ìŠ¤ì›Œë“œ ê¸°ì–µ
		<input type="checkbox" id="rememberMe" onclick="checkRememberMe()">ìë™ ë¡œê·¸ì¸
		<input type="button" id="btn_login" class="login_btn" value="ë¡œê·¸ì¸" onclick="loginCheck()"><hr>
		<div>ë‹¤ë¥¸ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸ í•˜ê¸°</div>
		<div class="authBox">		
			<a href="/oauth2/authorization/google">
				<img src="https://d1nuzc1w51n1es.cloudfront.net/d99d8628713bb69bd142.png" style="width:50px;">
				<div class="">Google</div>
			</a>
			<a href="/oauth2/authorization/kakao">
				<img src="https://d1nuzc1w51n1es.cloudfront.net/7edcff9c01ccc20d1ef6.png" style="width:50px;">
				<div class="">Kakao</div>
			</a>
			<a href="/oauth2/authorization/naver">
				<img src="https://phinf.pstatic.net/contact/78/2015/7/15/naveridlogin_1436952514384.png" style="width:50px;">
				<div class="">Naver</div>
			</a>
		</div>
		
	</form>
	
	<div class="bottomText"><a href="/user/findId">ì•„ì´ë”” ì°¾ê¸°</a>  |  <a href="/user/tempPw">ì„ì‹œë¹„ë°€ë²ˆí˜¸ ë°œê¸‰</a><br><br></div>
        <div class="bottomText">ì‚¬ìš©ìê°€ ì•„ë‹ˆë©´ ğŸ‘‰<a href="/user/signup">ì—¬ê¸°</a>ë¥¼ ëˆŒëŸ¬ ë“±ë¡ì„ í•´ì£¼ì„¸ìš”.<br><br></div>
</div>

<script>
	window.onload = async () => {
		
		//ì¿ í‚¤ ê°€ì ¸ ì˜¤ê¸°
		const getCookie = (name) => {
			
			const cookies = document.cookie.split(`; `).map((el) => el.split('='));
			  let getItem = [];
		
			  for (let i = 0; i < cookies.length; i++) {		    
			    if (cookies[i][0] === name) {
			      getItem.push(cookies[i][1]);
			      break;
			    }
			  }
			  if (getItem.length > 0) {
					console.log(getItem[0]);
			    	return decodeURIComponent(getItem[0]);
			  }		
		}
		
		let userid = getCookie('userid');
		let password = getCookie('password');
		let authkey = getCookie('authkey');
		
		//userid ê¸°ì–µí•˜ê¸° ì²´í¬ ì—¬ë¶€ í™•ì¸
		if(userid !== undefined){ //userid ì¿ í‚¤ê°€ ì¡´ì¬í•˜ë©´ 
			document.querySelector('#rememberUserid').checked = true; //userid ì²´í¬ë°•ìŠ¤ë¥¼ ì²´í¬
			document.querySelector('#userid').value = userid; //ë¡œê·¸ì¸ì°½ì˜ userid ì…ë ¥ë€ì— userid ì¿ í‚¤ ê°’ ì¶œë ¥ 
		}
		else document.querySelector('#rememberUserid').checked = false;
		
		//íŒ¨ìŠ¤ì›Œë“œ ê¸°ì–µí•˜ê¸° ì²´í¬ ì—¬ë¶€ í™•ì¸
		if(password !== undefined){ //íŒ¨ìŠ¤ì›Œë“œ ì¿ í‚¤ê°€ ì¡´ì¬í•˜ë©´
			document.querySelector('#rememberPassword').checked = true; 
			
			//Base64ë¡œ ì¸ì½”ë”© ëœ passwordë¥¼ ë””ì½”ë”©
			const decrypt = CryptoJS.enc.Base64.parse(password);
		    const hashData = decrypt.toString(CryptoJS.enc.Utf8);		    
		    password = hashData;
			
			document.querySelector('#password').value = password;//ë¡œê·¸ì¸ì°½ì˜ íŒ¨ìŠ¤ì›Œë“œ ì…ë ¥ë€ì— ë””ì½”íŒ… ëœ íŒ¨ìŠ¤ì›Œë“œ ì¿ í‚¤ ê°’ ì¶œë ¥ 
		}	
		else document.querySelector('#rememberPassword').checked = false;
		
		//ìë™ ë¡œê·¸ì¸ ì²˜ë¦¬
		if(authkey !== undefined){
			
			let formData = new FormData();
			formData.append("authkey",authkey);
			await fetch('/user/login?autologin=PASS',{
				method : 'POST',
				body : formData
			}).then((response) => response.json())
			  .then((data) => {
				 if(data.message == 'good'){				 
					 document.location.href='/';
				} else {
					alert("ì‹œìŠ¤í…œ ì¥ì• ë¡œ ìë™ ë¡œê·¸ì¸ì´ ì‹¤íŒ¨ í–ˆìŠµë‹ˆë‹¤.");		 
				}		  
		    }).catch((error)=> { console.log("error = " + error);} );
		}	
		
	}
	
	//ìë™ë¡œê·¸ì¸ ì²´í¬ ê´€ë¦¬
	const checkRememberMe = () => {
		
		if(document.querySelector('#rememberMe').checked){
			document.querySelector('#rememberUserid').checked = false;
			document.querySelector('#rememberPassword').checked = false;
		}
	}
	
	//ì´ë©”ì¼ ì²´í¬ ê´€ë¦¬
	const checkRememberUserid = () => {
		
		if(document.querySelector('#rememberUserid').checked)
			document.querySelector('#rememberMe').checked = false;
	}
	
	//íŒ¨ìŠ¤ì›Œë“œ ì²´í¬ ê´€ë¦¬
	const checkRememberPassword = () => {
		
		if(document.querySelector('#rememberPassword').checked){
			document.querySelector('#rememberMe').checked = false;
			let rememberPwCheck = confirm("ê³µìš©PC ë¼ë©´ íŒ¨ìŠ¤ì›Œë“œ ê¸°ì–µ ì‹œ ë³´ì•ˆ ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤.\nê°œì¸ìš© PCê°€ ë§ìŠµë‹ˆê¹Œ?");
			if(!rememberPwCheck)
				document.querySelector('#rememberPassword').checked = false;
		}
	}	
	
	//ë¡œê·¸ì¸ ì²˜ë¦¬
	const login = () => {
		document.loginForm.action = '/';
		document.loginForm.submit();
	}
	
	//ë¡œê·¸ì¸ ì²˜ë¦¬
	const loginCheck = async () => {
		
		let userid = document.querySelector('#userid');
		let password = document.querySelector('#password');
		let rememberMe = document.querySelector('#rememberMe');
		
		if(userid.value === ''){
			alert('ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
			userid.focus();
			return false; //falseë¥¼ ì•ˆ ì ìœ¼ë©´ í•¨ìˆ˜ ì‹¤í–‰ì„ ì¢…ë£Œ
		}
		
	    if(password.value === ''){
	    	alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
	    	password.focus();
	    	return false;
	    }
	
	    //ë¦¬ë©¤ë²„ë¯¸ í•­ëª© ì²´í¬ í™•ì¸í•˜ì—¬ ìë™ ë¡œê·¸ì¸ ì—¬ë¶€ë¥¼ ê²°ì •
		let formData = new FormData();
		formData.append("userid", userid.value);
		formData.append("password", password.value);
	
		await fetch('/user/loginCheck?autologin=NEW',{
			method : 'POST',
			body : formData
		}).then((response) => response.json())
		  .then((data) => {
			 if(data.message == 'good'){				 
				 cookieManage(userid.value,password.value,data.authkey);
				 //document.location.href='/';
				 login();
			} else if(data.message === 'ID_NOT_FOUND') {
				 	msg.innerHTML = 'ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤.';
			} else if(data.message === 'PASSWORD_NOT_FOUND') {
					msg.innerHTML = 'ì˜ëª»ëœ íŒ¨ìŠ¤ì›Œë“œì…ë‹ˆë‹¤.';
			} else {
				console.log("message = " + data.message);
				alert("ì‹œìŠ¤í…œ ì¥ì• ë¡œ ë¡œê·¸ì¸ì´ ì‹¤íŒ¨ í–ˆìŠµë‹ˆë‹¤.");		 
			}		  
	    }).catch((error)=> { console.log("error = " + error);} );
	    
	}
	
	//ì¿ í‚¤ ê´€ë¦¬ --> ì¿ í‚¤ ìƒì„±
	const cookieManage = (userid,password,authkey) => {

		if(rememberUserid.checked) {
			document.cookie = 'userid=' + userid + ';path=/; expires=Sun, 31 Dec 2023 23:59:59 GMT';
		} else document.cookie = 'userid=' + userid + ';path=/; max-age=0';
		
		if(rememberPassword.checked) {
			
			//Base64(ì–‘ë°©í–¥ ë³µí˜¸í™”)ë¡œ íŒ¨ìŠ¤ì›Œë“œ ì¸ì½”ë”©
			const key = CryptoJS.enc.Utf8.parse(password);
		    const base64 = CryptoJS.enc.Base64.stringify(key);
			password = base64;
		
			document.cookie = 'password=' + password + ';path=/; expires=Sun, 31 Dec 2023 23:59:59 GMT';
		} else document.cookie = 'password=' + password + ';path=/; max-age=0';	
	} 
	
	
	
	//ì—”í„°í‚¤ ëˆŒëŸ¬ì„œ ë¡œê·¸ì¸ ë˜ë„ë¡ í•˜ëŠ” ê¸°ëŠ¥ ì œê³µ
	const press = () =>{
		if(event.keyCode == 13){loginCheck();}
		
	}
	
</script>

<!-- ê°œë°œ ì˜ì—­ ë -->
</th:block>
</html>